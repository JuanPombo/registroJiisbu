<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro con QR</title>
  <style>
    video {
      width: 100%;
      border-radius: 10px;
    }
    #qr-result {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h1>Escanea tu QR</h1>
  <video id="qr-video"></video>
  <div id="qr-result"></div>
  <input type="text" id="cedula-input" placeholder="O ingrese cédula manualmente">
  <button id="submit-manual">Enviar</button>

  <script type="module">
    import QrScanner from './qr-scanner.umd.min.js'; // o desde CDN si prefieres
    QrScanner.WORKER_PATH = './qr-scanner-worker.min.js';

    const video = document.getElementById('qr-video');
    const resultDiv = document.getElementById('qr-result');
    const manualInput = document.getElementById('cedula-input');
    const manualBtn = document.getElementById('submit-manual');

    const scanner = new QrScanner(video, result => {
      scanner.stop();
      handleCédula(result);
    });

    scanner.start().catch(err => {
      resultDiv.textContent = 'Error accediendo a la cámara: ' + err;
    });

    function handleCédula(cedula) {
      resultDiv.textContent = 'Procesando cédula: ' + cedula;
      fetch('/update_sheet', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ cedula })
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          resultDiv.textContent = `✔ Bienvenido/a: ${data.nombre || cedula}`;
        } else {
          resultDiv.textContent = `✗ ${data.message}`;
        }
      })
      .catch(err => {
        resultDiv.textContent = 'Error en el servidor: ' + err;
      });
    }

    manualBtn.onclick = () => {
      const cedula = manualInput.value.trim();
      if (/^\d+$/.test(cedula)) {
        handleCédula(cedula);
      } else {
        resultDiv.textContent = 'Ingrese una cédula válida';
      }
    };
  </script>
</body>
</html>
